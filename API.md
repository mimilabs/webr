# WebR API Documentation

A standalone Next.js API server for executing R code using WebR (R in WebAssembly) on AWS EC2.

## Features

- Execute R code in a sandboxed WebAssembly environment
- Pre-installed R packages: ggplot2, dplyr, tidyr, survey, srvyr, broom
- Automatic plot generation and base64 encoding
- SQL data injection as R data frames
- Warm WebR instance for fast execution
- CORS enabled for mimilabs.ai domains
- Health check endpoint
- PM2 process management for production

## API Endpoints

### POST /api/execute

Execute R code and return results, including plots.

#### Request

```json
{
  "code": "library(ggplot2)\nggplot(mtcars, aes(x=wt, y=mpg)) + geom_point()",
  "data": [
    {"id": 1, "value": 10},
    {"id": 2, "value": 20}
  ]
}
```

**Parameters:**

- `code` (string, required): R code to execute
- `data` (array, optional): JSON array to inject as R data frame named `query_result`

#### Response

```json
{
  "success": true,
  "output": "[1] 2\n",
  "plots": ["iVBORw0KGgoAAAANSUhEUgAA..."],
  "error": null,
  "executionTime": 1234
}
```

**Response Fields:**

- `success` (boolean): Whether execution succeeded
- `output` (string): Captured R console output
- `plots` (array): Array of base64-encoded PNG images
- `error` (string|null): Error message if execution failed
- `executionTime` (number): Execution time in milliseconds

#### Example Usage

**Basic R Execution:**

```bash
curl -X POST http://localhost:3000/api/execute \
  -H "Content-Type: application/json" \
  -d '{
    "code": "print(1 + 1)"
  }'
```

**With ggplot2:**

```bash
curl -X POST http://localhost:3000/api/execute \
  -H "Content-Type: application/json" \
  -d '{
    "code": "library(ggplot2)\nggplot(mtcars, aes(x=wt, y=mpg)) + geom_point() + theme_minimal()"
  }'
```

**With Data Injection:**

```bash
curl -X POST http://localhost:3000/api/execute \
  -H "Content-Type: application/json" \
  -d '{
    "code": "library(dplyr)\nquery_result %>% summarise(mean_value = mean(value), count = n())",
    "data": [
      {"id": 1, "value": 10},
      {"id": 2, "value": 20},
      {"id": 3, "value": 30}
    ]
  }'
```

**Complex Analysis with Multiple Plots:**

```bash
curl -X POST http://localhost:3000/api/execute \
  -H "Content-Type: application/json" \
  -d '{
    "code": "library(ggplot2)\nlibrary(dplyr)\n\n# Summary statistics\ncat(\"Dataset summary:\\n\")\nprint(summary(mtcars))\n\n# Plot 1: Scatter plot\nggplot(mtcars, aes(x=wt, y=mpg)) + \n  geom_point() + \n  geom_smooth(method=\"lm\") +\n  theme_minimal() +\n  labs(title=\"Weight vs MPG\")\n\n# Plot 2: Histogram\nggplot(mtcars, aes(x=mpg)) + \n  geom_histogram(bins=10, fill=\"steelblue\") +\n  theme_minimal() +\n  labs(title=\"MPG Distribution\")"
  }'
```

### GET /api/health

Health check endpoint to verify server status.

#### Request

```bash
curl http://localhost:3000/api/health
```

#### Response

```json
{
  "status": "ok",
  "webrInitialized": true,
  "timestamp": "2024-01-15T12:00:00.000Z",
  "uptime": 123.456
}
```

**Response Fields:**

- `status` (string): Always "ok" if server is responding
- `webrInitialized` (boolean): Whether WebR instance is initialized and ready
- `timestamp` (string): Current server timestamp (ISO 8601)
- `uptime` (number): Server uptime in seconds

## Pre-installed R Packages

The following packages are automatically installed on server startup:

- **ggplot2**: Data visualization
- **dplyr**: Data manipulation
- **tidyr**: Data tidying
- **survey**: Survey statistics
- **srvyr**: dplyr-style survey analysis
- **broom**: Tidy model outputs

## Data Injection

When you provide a `data` parameter, it's automatically converted to an R data frame named `query_result`:

```json
{
  "code": "library(dplyr)\nquery_result %>% filter(value > 15)",
  "data": [
    {"id": 1, "value": 10},
    {"id": 2, "value": 20},
    {"id": 3, "value": 30}
  ]
}
```

The `query_result` data frame will be available in your R code with the correct column types.

## Plot Handling

### Automatic Plot Capture

All plots generated by your R code are automatically:
1. Saved to `/tmp` as PNG files (800x600 pixels)
2. Converted to base64-encoded strings
3. Returned in the `plots` array

### Multiple Plots

If your code generates multiple plots, all will be captured and returned:

```r
library(ggplot2)

# Plot 1
ggplot(mtcars, aes(x=wt, y=mpg)) + geom_point()

# Plot 2
ggplot(mtcars, aes(x=hp, y=mpg)) + geom_point()
```

Both plots will be in the response `plots` array as separate base64 strings.

### Using ggsave

You can also explicitly save plots using `ggsave()`:

```r
library(ggplot2)

p <- ggplot(mtcars, aes(x=wt, y=mpg)) + geom_point()
ggsave("/tmp/myplot.png", p, width=10, height=6, dpi=150)
```

## Error Handling

### R Errors

If your R code contains errors, they will be captured and returned:

```json
{
  "success": true,
  "output": "Error: object 'nonexistent' not found\n",
  "plots": [],
  "error": null,
  "executionTime": 123
}
```

Note: R errors are captured in the output, so `success` is still `true`. The request itself succeeded.

### API Errors

If the request itself fails (missing code, server error, etc.):

```json
{
  "success": false,
  "output": "",
  "plots": [],
  "error": "Missing or invalid \"code\" parameter",
  "executionTime": 5
}
```

## CORS Configuration

CORS is enabled for the following origins:
- `https://www.mimilabs.ai`
- `https://mimilabs.ai`

To modify allowed origins, edit:
- `app/api/execute/route.ts`
- `app/api/health/route.ts`

## Performance Considerations

### First Request

The very first request after server startup will take 2-5 minutes as:
1. WebR initializes
2. R packages are downloaded and installed from https://repo.r-wasm.org/

**Recommendation**: Make a warmup request after deployment:

```bash
curl -X POST http://localhost:3000/api/execute \
  -H "Content-Type: application/json" \
  -d '{"code": "library(ggplot2)\nprint(\"ready\")"}'
```

### Subsequent Requests

After initialization:
- WebR instance stays warm in memory
- Packages remain loaded
- Typical execution time: 100-500ms (depending on code complexity)

### Timeouts

- Default Next.js timeout: 60 seconds
- Nginx proxy timeout: 300 seconds (if using reverse proxy)

For long-running analyses, ensure your reverse proxy timeout is configured appropriately.

## Example Use Cases

### 1. Statistical Analysis

```json
{
  "code": "library(broom)\nmodel <- lm(mpg ~ wt + hp, data=mtcars)\ntidy(model)"
}
```

### 2. Survey Analysis

```json
{
  "code": "library(survey)\nlibrary(srvyr)\n\ndata <- data.frame(\n  age = c(25, 30, 35, 40, 45),\n  income = c(30000, 40000, 50000, 60000, 70000),\n  weight = c(1.2, 1.0, 0.8, 1.1, 0.9)\n)\n\nsvy <- data %>% as_survey_design(weights = weight)\nsvy %>% summarise(mean_income = survey_mean(income))"
}
```

### 3. Data Visualization

```json
{
  "code": "library(ggplot2)\nlibrary(dplyr)\n\nmtcars %>%\n  ggplot(aes(x=factor(cyl), y=mpg, fill=factor(cyl))) +\n  geom_boxplot() +\n  theme_minimal() +\n  labs(title=\"MPG by Cylinder Count\", x=\"Cylinders\", y=\"Miles Per Gallon\", fill=\"Cylinders\")"
}
```

### 4. SQL Results Analysis

```json
{
  "code": "library(dplyr)\nlibrary(ggplot2)\n\n# query_result is automatically available\nsummary_stats <- query_result %>%\n  group_by(category) %>%\n  summarise(\n    count = n(),\n    mean_value = mean(value),\n    sd_value = sd(value)\n  )\n\nprint(summary_stats)\n\nggplot(summary_stats, aes(x=category, y=mean_value)) +\n  geom_col(fill=\"steelblue\") +\n  theme_minimal()",
  "data": [
    {"category": "A", "value": 10},
    {"category": "A", "value": 12},
    {"category": "B", "value": 20},
    {"category": "B", "value": 22}
  ]
}
```

## Limitations

1. **Execution Time**: Long-running code may timeout (default 60s)
2. **Memory**: Limited by EC2 instance memory (recommend 4GB+)
3. **File System**: `/tmp` is the only writable directory
4. **Packages**: Only pre-installed packages are available (no dynamic installation)
5. **Parallelization**: Single R process per request (no multi-core support within WebR)

## Security Notes

1. **Sandboxing**: WebR runs in WebAssembly, providing isolation from the host system
2. **No Network Access**: R code cannot make external network requests
3. **File System**: Limited to `/tmp` directory only
4. **CORS**: Restrict to your domains in production
5. **Rate Limiting**: Consider adding rate limiting for production use

## Troubleshooting

### WebR Not Initialized

If `webrInitialized` is `false` in the health check:
- Server is still initializing
- Check logs: `pm2 logs webr-api`
- Wait 2-5 minutes for package installation

### Plots Not Returning

- Ensure you're using ggplot2 or base R graphics
- Check that plots are actually generated (no errors in output)
- Verify `/tmp` is writable: `ls -la /tmp`

### Memory Issues

- Increase EC2 instance size
- Add swap space (see DEPLOYMENT.md)
- Simplify R code or reduce data size

## Support

- Deployment Guide: See `DEPLOYMENT.md`
- WebR Documentation: https://docs.r-wasm.org/webr/latest/
- Next.js Documentation: https://nextjs.org/docs
